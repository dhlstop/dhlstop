<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego STOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .dhl-yellow {
            background-color: #FFCC00; /* DHL Yellow */
            color: #333;
        }
        .dhl-red {
            background-color: #CC0000; /* DHL Red */
            color: #fff;
        }
        .text-dhl-red {
            color: #CC0000; /* DHL Red text color */
        }
        /* Updated button styles */
        .btn-primary, .btn-secondary, .modal-button {
            @apply px-6 py-3 rounded-lg font-bold transition-all duration-300 ease-in-out shadow-md;
            background-color: #FFCC00; /* DHL Yellow */
            color: #CC0000; /* DHL Red */
            border: 2px solid #CC0000; /* Red border */
        }
        .btn-primary:hover, .btn-secondary:hover, .modal-button:hover {
            background-color: #CC0000; /* DHL Red on hover */
            color: #FFCC00; /* DHL Yellow text on hover */
            border-color: #FFCC00; /* Yellow border on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Subtle shadow change */
        }

        /* Updated input[type="text"] styles for red border and red text */
        input[type="text"] {
            @apply p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-dhl-red;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid #CC0000; /* Red border */
            color: #CC0000; /* Red text color */
        }
        input[type="text"]::placeholder {
            color: rgba(204, 0, 0, 0.7); /* Lighter red for placeholder */
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #CC0000; /* DHL Red */
        }
        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 25px;
            color: #333;
        }
        /* Style for the name input modal */
        #name-input-modal .modal-content,
        #letter-input-modal .modal-content,
        #final-results-modal .modal-content { /* Added final-results-modal */
            padding: 40px;
        }
        #name-input-modal input,
        #letter-input-modal input {
            margin-bottom: 15px;
        }
        #letter-input-modal input {
            text-align: center;
            text-transform: uppercase;
            font-size: 2rem;
            width: 80px; /* Smaller width for single letter */
        }
        #name-input-error-message,
        #letter-input-error-message { /* Added letter-input-error-message */
            color: #CC0000; /* DHL Red for error message */
            font-weight: bold;
            margin-top: -10px; /* Adjust spacing */
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container">
        <!-- DHL Logo as Header -->
        <div class="flex justify-center mb-6">
            <img src="logo.png" alt="DHL Logo" class="h-auto max-w-full rounded-lg" style="width: 400px;">
        </div>
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-6">¡Juego STOP DHL!</h1>

        <!-- Game Info and Controls -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 p-5 rounded-xl dhl-yellow shadow-lg">
            <div class="text-center md:text-left">
                <p class="text-lg font-semibold text-gray-700">Ronda: <span id="round-counter" class="text-2xl font-bold text-dhl-red">0 / 3</span></p>
                <p class="text-lg font-semibold text-gray-700">Letra Actual: <span id="current-letter" class="text-4xl font-extrabold text-dhl-red">?</span></p>
            </div>
            <div class="flex gap-4">
                <button id="start-round-btn" class="btn-primary">Iniciar Ronda</button>
                <button id="stop-btn" class="btn-secondary" disabled>¡STOP!</button>
                <button id="restart-btn" class="btn-primary">Volver a Comenzar</button>
            </div>
        </div>

        <!-- Categories and Participants Input Grid -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-xl shadow-lg">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Categoría</th>
                        <th class="py-3 px-6 text-center" colspan="1">Participante</th>
                    </tr>
                    <tr class="uppercase text-sm leading-normal">
                        <th class="py-2 px-4 text-left dhl-yellow text-dhl-red"></th>
                        <th class="py-2 px-4 text-center dhl-yellow text-dhl-red" id="player-header">Jugador</th>
                    </tr>
                </thead>
                <tbody id="game-inputs" class="text-gray-700 text-sm">
                    <!-- Input rows will be dynamically generated here -->
                </tbody>
            </table>
        </div>

        <!-- Scoreboard -->
        <div class="p-5 rounded-xl bg-gray-50 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Marcador</h2>
            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                <thead>
                    <tr class="uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left dhl-yellow text-dhl-red">Participante</th>
                        <th class="py-3 px-6 text-center dhl-yellow text-dhl-red">Ronda 1</th>
                        <th class="py-3 px-6 text-center dhl-yellow text-dhl-red">Ronda 2</th>
                        <th class="py-3 px-6 text-center dhl-yellow text-dhl-red">Ronda 3</th>
                        <th class="py-3 px-6 text-center dhl-yellow text-dhl-red">Puntos Totales</th>
                    </tr>
                </thead>
                <tbody id="scoreboard" class="text-gray-700 text-sm">
                    <!-- Score rows will be dynamically generated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for general messages (e.g., Round X, STOP!) -->
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title"></h3>
            <p id="modal-message" class="modal-message"></p>
            <button id="modal-close-btn" class="modal-button">Cerrar</button>
        </div>
    </div>

    <!-- Modal for Name Input -->
    <div id="name-input-modal" class="modal show">
        <div class="modal-content">
            <h3 class="modal-title">¡Bienvenido al Juego STOP de DHL!</h3>
            <p class="modal-message">Por favor, ingresa tu nombre y apellido para comenzar.</p>
            <input type="text" id="player-name-input" placeholder="Nombre" class="mb-3">
            <input type="text" id="player-surname-input" placeholder="Apellido" class="mb-5">
            <div id="name-input-error-message" class="text-dhl-red mb-3"></div>
            <button id="start-game-btn-modal" class="modal-button">Comenzar Juego</button>
        </div>
    </div>

    <!-- Modal for Letter Input -->
    <div id="letter-input-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Letra para la Ronda <span id="round-number-letter-modal"></span></h3>
            <p class="modal-message">Ingresa una letra para esta ronda:</p>
            <input type="text" id="letter-input" maxlength="1" class="mb-3">
            <div id="letter-input-error-message" class="text-dhl-red mb-3"></div> <!-- New error message div -->
            <button id="submit-letter-btn" class="modal-button">Confirmar Letra</button>
        </div>
    </div>

    <!-- New Modal for Final Results -->
    <div id="final-results-modal" class="modal">
        <div class="modal-content">
            <h3 id="final-modal-title" class="modal-title"></h3>
            <p id="final-modal-score" class="modal-message"></p>
            <div id="final-modal-round-times" class="modal-message"></div> <!-- To show round times -->
            <p id="dhl-team-message" class="modal-message text-dhl-red font-semibold"></p>
            <button id="final-modal-close-btn" class="modal-button">Cerrar</button>
        </div>
    </div>

    <script>
        // --- Utility Functions ---
        function showModal(modalElement) {
            modalElement.classList.add('show');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('show');
        }

        /**
         * Displays a message in the general game modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {boolean} isFinalRoundModal - True if this is the modal for the final round's results, to change button behavior.
         */
        function showMessage(title, message, isFinalRoundModal = false) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            showModal(gameModal);
            // Disable main game buttons while a modal is open
            restartBtn.disabled = true;
            startRoundBtn.disabled = true;

            // Dynamically set the close button text and behavior for gameModal
            if (isFinalRoundModal) {
                modalCloseBtn.textContent = "Ver Resultados Finales";
                modalCloseBtn.onclick = () => {
                    hideModal(gameModal);
                    endGame(); // Call endGame when this specific button is clicked
                };
            } else {
                modalCloseBtn.textContent = "Cerrar";
                modalCloseBtn.onclick = () => {
                    hideModal(gameModal);
                    // Re-enable main game buttons after closing if not the final round
                    startRoundBtn.disabled = false;
                    restartBtn.disabled = false;
                };
            }
        }

        function clearAllInputs() {
            document.querySelectorAll('.input-field').forEach(input => {
                input.value = '';
            });
        }

        function enableAllInputs() {
            document.querySelectorAll('.input-field').forEach(input => {
                input.disabled = false;
            });
        }

        function disableAllInputs() {
            document.querySelectorAll('.input-field').forEach(input => {
                input.disabled = true;
            });
        }

        // --- Game configuration ---
        const categories = ["Fruta", "País o Capital", "Parte del Cuerpo", "Algo relacionado a DHL", "Marca"];
        const numParticipants = 1;
        const totalRounds = 3;
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        // --- Game state variables ---
        let currentRound = 0;
        let currentLetter = '';
        let gameStarted = false;
        let roundActive = false;
        let inputsFrozen = false;
        let scores = [];
        let playerName = "Jugador";
        let playerSurname = "";
        let roundStartTime; // To track when the round started for time calculation
        let usedLetters = []; // Array to store used letters to prevent repetition

        // --- DOM elements ---
        const roundCounterEl = document.getElementById('round-counter');
        const currentLetterEl = document.getElementById('current-letter');
        const startRoundBtn = document.getElementById('start-round-btn');
        const stopBtn = document.getElementById('stop-btn');
        const restartBtn = document.getElementById('restart-btn');
        const gameInputsEl = document.getElementById('game-inputs');
        const scoreboardEl = document.getElementById('scoreboard');
        const gameModal = document.getElementById('game-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const nameInputModal = document.getElementById('name-input-modal');
        const playerNameInput = document.getElementById('player-name-input');
        const playerSurnameInput = document.getElementById('player-surname-input');
        const startGameBtnModal = document.getElementById('start-game-btn-modal');
        const playerHeaderEl = document.getElementById('player-header');
        const nameInputErrorMessage = document.getElementById('name-input-error-message');

        const letterInputModal = document.getElementById('letter-input-modal');
        const roundNumberLetterModal = document.getElementById('round-number-letter-modal');
        const letterInput = document.getElementById('letter-input');
        const letterInputErrorMessage = document.getElementById('letter-input-error-message');
        const submitLetterBtn = document.getElementById('submit-letter-btn');

        const finalResultsModal = document.getElementById('final-results-modal');
        const finalModalTitle = document.getElementById('final-modal-title');
        const finalModalScore = document.getElementById('final-modal-score');
        const finalModalRoundTimes = document.getElementById('final-modal-round-times');
        const dhlTeamMessage = document.getElementById('dhl-team-message');
        const finalModalCloseBtn = document.getElementById('final-modal-close-btn');


        // --- Initialization ---
        function initializeGame() {
            scores = [{
                participantId: 0,
                total: 0,
                roundScores: Array(totalRounds).fill(0),
                timeTakenPerRound: Array(totalRounds).fill('00:00')
            }];
            usedLetters = []; // Initialize used letters
            renderGameInputs();
            updateScoreboard();
            resetGameUI(); // Calls resetGameUI to set initial state and show name input modal
        }

        /**
         * Resets the game UI and state to its initial conditions.
         */
        function resetGameUI() {
            currentRound = 0;
            currentLetter = '?';
            gameStarted = false;
            roundActive = false;
            inputsFrozen = false;
            roundCounterEl.textContent = `${currentRound} / ${totalRounds}`;
            currentLetterEl.textContent = currentLetter;
            startRoundBtn.disabled = false;
            stopBtn.disabled = true;
            clearAllInputs();
            disableAllInputs();
            playerName = "Jugador"; // Reset player name
            playerSurname = ""; // Reset player surname
            playerHeaderEl.textContent = "Jugador"; // Reset header
            scores = [{
                participantId: 0,
                total: 0,
                roundScores: Array(totalRounds).fill(0),
                timeTakenPerRound: Array(totalRounds).fill('00:00')
            }];
            usedLetters = []; // Reset used letters on full game restart
            updateScoreboard();
            // Hide all modals to ensure a clean start
            hideModal(gameModal);
            hideModal(letterInputModal);
            hideModal(finalResultsModal);
            showModal(nameInputModal); // Show name input modal to start a new game
            playerNameInput.value = ""; // Clear name input
            playerSurnameInput.value = ""; // Clear surname input
            letterInput.value = ""; // Clear letter input
            nameInputErrorMessage.textContent = ""; // Clear error messages
            letterInputErrorMessage.textContent = "";
        }

        /**
         * Renders the input fields for each category.
         */
        function renderGameInputs() {
            gameInputsEl.innerHTML = '';

            categories.forEach(category => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

                const categoryCell = document.createElement('td');
                categoryCell.classList.add('py-3', 'px-6', 'text-left', 'font-semibold');
                categoryCell.textContent = category;
                row.appendChild(categoryCell);

                const inputCell = document.createElement('td');
                inputCell.classList.add('py-3', 'px-6', 'text-center');

                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('input-field');
                input.placeholder = `Tu respuesta`;
                input.dataset.category = category;
                input.dataset.participantId = 0;
                input.disabled = true; // Inputs are disabled until a round starts
                inputCell.appendChild(input);
                row.appendChild(inputCell);

                gameInputsEl.appendChild(row);
            });
        }

        /**
         * Updates the scoreboard with current scores and times.
         */
        function updateScoreboard() {
            scoreboardEl.innerHTML = '';

            const playerScore = scores[0];
            const row = document.createElement('tr');
            row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');

            const nameCell = document.createElement('td');
            nameCell.classList.add('py-3', 'px-6', 'text-left');
            nameCell.textContent = `${playerName} ${playerSurname}`;
            row.appendChild(nameCell);

            // Add cells for each round's score
            for (let i = 0; i < totalRounds; i++) {
                const roundScoreCell = document.createElement('td');
                roundScoreCell.classList.add('py-3', 'px-6', 'text-center', 'font-bold');
                roundScoreCell.textContent = playerScore.roundScores[i] !== undefined ? playerScore.roundScores[i] : '-';
                row.appendChild(roundScoreCell);
            }

            const totalScoreCell = document.createElement('td');
            totalScoreCell.classList.add('py-3', 'px-6', 'text-center', 'font-bold', 'text-dhl-red');
            totalScoreCell.textContent = playerScore.total;
            row.appendChild(totalScoreCell);

            scoreboardEl.appendChild(row);
        }

        // --- Game Flow Functions ---

        /**
         * Starts a new game after player name input.
         */
        function startGame() {
            const name = playerNameInput.value.trim();
            const surname = playerSurnameInput.value.trim();

            if (name === "" || surname === "") {
                nameInputErrorMessage.textContent = "Por favor, ingresa tu nombre y apellido para comenzar el juego.";
                return;
            }

            nameInputErrorMessage.textContent = "";
            playerName = name;
            playerSurname = surname;
            playerHeaderEl.textContent = `${playerName} ${playerSurname}`;
            hideModal(nameInputModal);

            gameStarted = true;
            // Reset scores and used letters for a fresh game
            scores[0].total = 0;
            scores[0].roundScores = Array(totalRounds).fill(0);
            scores[0].timeTakenPerRound = Array(totalRounds).fill('00:00');
            usedLetters = [];
            updateScoreboard();
            promptForLetter(); // Prompt for the first letter
        }

        /**
         * Shows the modal to prompt the user for a letter for the current round.
         */
        function promptForLetter() {
            roundNumberLetterModal.textContent = currentRound + 1;
            letterInput.value = "";
            letterInputErrorMessage.textContent = ""; // Clear previous error message
            showModal(letterInputModal);
        }

        /**
         * Handles the submission of the letter for the round.
         * Validates the letter and starts the round if valid.
         */
        function submitLetter() {
            const letter = letterInput.value.trim().toUpperCase();

            // Validate if it's a single alphabet character
            if (letter.length !== 1 || !/^[A-Z]$/.test(letter)) {
                letterInputErrorMessage.textContent = "Por favor, ingresa una sola letra válida del alfabeto.";
                return;
            }

            // Check if the letter has already been used
            if (usedLetters.includes(letter)) {
                letterInputErrorMessage.textContent = `La letra "${letter}" ya ha sido utilizada. Elige otra.`;
                return;
            }

            letterInputErrorMessage.textContent = ""; // Clear error if valid
            usedLetters.push(letter); // Add to used letters array
            currentLetter = letter;
            hideModal(letterInputModal);
            startRound();
        }

        /**
         * Starts a new round of the game.
         */
        function startRound() {
            currentRound++;
            // This check is a safeguard; normal flow should prevent going beyond totalRounds here
            if (currentRound > totalRounds) {
                endGame();
                return;
            }

            roundCounterEl.textContent = `${currentRound} / ${totalRounds}`;
            currentLetterEl.textContent = currentLetter;

            clearAllInputs();
            enableAllInputs();
            startRoundBtn.disabled = true;
            stopBtn.disabled = false;
            restartBtn.disabled = false;
            roundActive = true;
            inputsFrozen = false;

            updateScoreboard();

            // Reset round answers (though not strictly necessary for single player, good practice)
            roundAnswers = {};
            categories.forEach(cat => roundAnswers[cat] = {});

            roundStartTime = Date.now(); // Record the start time of the round

            // Show initial round message
            showMessage(`¡Ronda ${currentRound}!`, `La letra es: "${currentLetter}". ¡Comienza a escribir!`, false);
        }

        /**
         * Stops the current round, calculates time taken, and prepares for scoring.
         */
        function stopGame() {
            // Prevent multiple calls if already stopped or frozen
            if (!roundActive && !inputsFrozen) return;

            const timeElapsedMs = Date.now() - roundStartTime; // Calculate time spent in milliseconds
            const totalSeconds = Math.floor(timeElapsedMs / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            // Store the time taken for the current round
            scores[0].timeTakenPerRound[currentRound - 1] = `${minutes}:${seconds}`;

            inputsFrozen = true;
            roundActive = false;
            stopBtn.disabled = true;
            disableAllInputs(); // Disable inputs once STOP is pressed

            showMessage("¡STOP!", "Calculando puntos de la ronda...", false); // Show calculating message

            // Delay calculation to allow user to see "Calculating points..." message
            setTimeout(() => {
                calculateRoundScores();
                updateScoreboard();
            }, 1500);
        }

        /**
         * Calculates scores for the current round based on answers.
         */
        function calculateRoundScores() {
            const inputFields = document.querySelectorAll('.input-field');
            let roundScore = 0;
            let roundSummary = '';

            categories.forEach(category => {
                roundSummary += `<h4 class="font-bold text-lg text-dhl-red mt-4">${category}:</h4>`;
                const input = Array.from(inputFields).find(input => input.dataset.category === category);
                const answer = input.value.trim().toUpperCase();
                let points = 0;
                let status = '0 pts (Incorrecto/Vacío)';

                const startsWithCorrectLetter = answer && answer.startsWith(currentLetter);

                if (startsWithCorrectLetter) {
                    // As per the requirement, any non-empty answer starting with the correct letter is valid.
                    points = 10;
                    status = '10 pts (Válido)'; // Status message for valid answers
                } else {
                    status = '0 pts (No comienza con la letra correcta o vacío)'; // Status message for invalid answers
                }
                roundScore += points;
                roundSummary += `<p>${answer || 'Vacío'}: ${status}</p>`;
            });

            scores[0].roundScores[currentRound - 1] = roundScore; // Store current round's score
            scores[0].total += roundScore; // Add to total score

            // Show round results modal. If it's the last round, set button to trigger endGame.
            showMessage(`Resultados Ronda ${currentRound}`, roundSummary, currentRound === totalRounds);

            updateScoreboard(); // Update scoreboard with current round's score
        }

        /**
         * Ends the game, displays final results, and the DHL message.
         */
        function endGame() {
            gameStarted = false;
            stopBtn.disabled = true;
            startRoundBtn.disabled = false; // Enable for a new game
            restartBtn.disabled = false; // Enable restart button

            const finalScore = scores[0].total;
            finalModalTitle.textContent = "¡Juego Terminado!";
            finalModalScore.textContent = `Tu puntuación final es: ${finalScore} puntos.`;

            let roundTimesHtml = '<h4>Tiempos por Ronda:</h4>';
            scores[0].timeTakenPerRound.forEach((time, index) => {
                roundTimesHtml += `<p>Ronda ${index + 1}: ${time}</p>`;
            });
            finalModalRoundTimes.innerHTML = roundTimesHtml;

            dhlTeamMessage.innerHTML = `En DHL, cada entrega es un esfuerzo de equipo. ¡Tu dedicación en este juego refleja el espíritu de excelencia que nos impulsa! ¡Gracias por ser parte de nuestro equipo!`;
            showModal(finalResultsModal); // Show the final results modal

            // The final modal's close button will just hide the modal, not reset the game
            finalModalCloseBtn.onclick = () => {
                hideModal(finalResultsModal);
                // Game state remains as finished, user can use "Volver a Comenzar" on main UI
            };
        }

        // --- Event Listeners ---
        startRoundBtn.addEventListener('click', promptForLetter);
        stopBtn.addEventListener('click', stopGame);
        restartBtn.addEventListener('click', resetGameUI); // This button explicitly restarts the game

        // The modalCloseBtn.addEventListener is now handled dynamically within showMessage.
        // No need for a static listener here anymore.

        startGameBtnModal.addEventListener('click', startGame);
        submitLetterBtn.addEventListener('click', submitLetter);
        // finalModalCloseBtn listener is defined within endGame() for clarity of flow.

        // Initial setup
        initializeGame();
    </script>
</body>
</html>
